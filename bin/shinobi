#!/usr/bin/env ruby
$:.unshift(File.expand_path("../../lib", __FILE__))

require "yaml"
require "shinobi"
require "optparse"

options = {:config => File.expand_path("../config/printers.yml", __FILE__), :modify => true}
OptionParser.new do |opts|
  opts.banner = "Usage: shinobi [options]"

  opts.on("-c", "--config config_file", "Specify the configuration file") do |c|
    options[:config] = c
  end
  
  opts.on("--[no-]modify", "Allow the addition and deletion of printers") do |m|
    options[:modify] = m
  end
end.parse!

ninja = Shinobi.parse
if File.exists?(options[:config])
  saved = YAML.load(File.read(options[:config]))
  
  to_be_removed = saved.keys - ninja.keys
  to_be_added = ninja.keys - saved.keys
  
  if options[:modify]
    to_be_removed.each { |k| Shinobi.uninstall(k) }
    to_be_added.each { |k| Shinobi.install(k, ninja[k]) }
  end
else
  File.open(options[:config], "w") { |file| file.write(YAML.dump(ninja)) }
  ninja.keys.each { |k| Shinobi.install(k, ninja[k]) } if options[:modify]
end